# SSH Key Management and Rotation Script

A comprehensive Python script for managing SSH keys including generation, rotation, backup, validation, and deployment to remote servers.

## Description

This script provides a complete solution for SSH key lifecycle management. It helps system administrators and security-conscious users maintain secure SSH access by automating key rotation, ensuring proper backups, and validating key configurations.

### Key Features

- **Generate SSH Key Pairs**: Create new RSA, Ed25519, or ECDSA key pairs
- **Key Rotation**: Safely rotate existing keys with automatic backup
- **Backup Management**: Create timestamped backups of SSH keys
- **Key Validation**: Verify key integrity and check proper permissions
- **Remote Deployment**: Deploy public keys to remote servers using ssh-copy-id
- **Key Listing**: View all SSH keys with their properties and status
- **Comprehensive Logging**: Detailed logging with verbose mode support

## Installation

### Prerequisites

- Python 3.6 or higher
- OpenSSH client tools (`ssh-keygen`, `ssh-copy-id`)
- Standard Python libraries (no external dependencies required)

### Setup

1. Download the script:
```bash
wget https://example.com/ssh_key_manager.py
# or clone from repository
```

2. Make the script executable:
```bash
chmod +x ssh_key_manager.py
```

3. Optionally, move to a directory in your PATH:
```bash
sudo mv ssh_key_manager.py /usr/local/bin/ssh-key-manager
```

## Usage

### Basic Syntax
```bash
python ssh_key_manager.py [global_options] <command> [command_options]
```

### Global Options
- `--ssh-dir PATH`: Specify SSH directory (default: ~/.ssh)
- `--verbose, -v`: Enable verbose output
- `--help, -h`: Show help message

### Commands

#### 1. Generate New SSH Key Pair

Generate a new SSH key pair with specified parameters:

```bash
# Generate default RSA 4096-bit key
python ssh_key_manager.py generate --key-name mykey

# Generate Ed25519 key (recommended for new keys)
python ssh_key_manager.py generate --key-name mykey --key-type ed25519

# Generate RSA key with custom size and comment
python ssh_key_manager.py generate --key-name mykey --key-type rsa --key-size 2048 --comment "My server key"
```

**Options:**
- `--key-name NAME`: Name for the key files (required)
- `--key-type TYPE`: Key type (rsa, ed25519, ecdsa) [default: rsa]
- `--key-size SIZE`: Key size in bits for RSA keys [default: 4096]
- `--comment TEXT`: Comment for the key [default: user@hostname]

#### 2. Rotate Existing SSH Key

Safely rotate an existing key by backing up the old one and generating a new one:

```bash
# Basic key rotation
python ssh_key_manager.py rotate --key-name mykey

# Rotate and deploy to multiple servers
python ssh_key_manager.py rotate --key-name mykey --servers server1.example.com,server2.example.com

# Rotate with different key type
python ssh_key_manager.py rotate --key-name mykey --new-key-type ed25519
```

**Options:**
- `--key-name NAME`: Name of the key to rotate (required)
- `--servers LIST`: Comma-separated list of servers to deploy new key to
- `--new-key-type TYPE`: Type for the new key [default: rsa]

#### 3. Backup SSH Keys

Create backups of all SSH keys:

```bash
# Backup to default location (~/.ssh/backups/backup_TIMESTAMP)
python ssh_key_manager.py backup

# Backup to custom directory
python ssh_key_manager.py backup --backup-dir ~/my_ssh_backups
```

**Options:**
- `--backup-dir PATH`: Custom backup directory

#### 4. Validate SSH Key

Check if an SSH key is valid and display its properties:

```bash
# Validate a public key
python ssh_key_manager.py validate --key-path ~/.ssh/id_rsa.pub

# Validate a private key
python ssh_key_manager.py validate --key-path ~/.ssh/id_rsa
```

**Options:**
- `--key-path PATH`: Path to the key file to validate (required)

#### 5. List All SSH Keys

Display all SSH keys in the SSH directory:

```bash
python ssh_key_manager.py list
```

#### 6. Deploy Key to Server

Deploy a public key to a remote server:

```bash
# Deploy with current username
python ssh_key_manager.py deploy --key-name mykey --server example.com

# Deploy with specific username
python ssh_key_manager.py deploy --key-name mykey --server example.com --username admin
```

**Options:**
- `--key-name NAME`: Name of the key to deploy (required)
- `--server HOST`: Server hostname or IP address (required)
- `--username USER`: Username for the server connection

### Examples

#### Complete Key Rotation Workflow

```bash
# 1. List current keys
python ssh_key_manager.py list

# 2. Backup existing keys
python ssh_key_manager.py backup

# 3. Rotate a specific key and deploy to servers
python ssh_key_manager.py rotate --key-name production-key \
    --servers web1.example.com,web2.example.com,db1.example.com \
    --new-key-type ed25519

# 4. Validate the new key
python ssh_key_manager.py validate --key-path ~/.ssh/production-key.pub
```

#### Setting Up New Server Access

```bash
# 1. Generate a new key for the server
python ssh_key_manager.py generate --key-name server-key --key-type ed25519

# 2. Deploy to the server
python ssh_key_manager.py deploy --key-name server-key --server newserver.example.com --username admin

# 3. Validate the deployment worked
ssh -i ~/.ssh/server-key admin@newserver.example.com "echo 'Connection successful'"
```

## Security Notes

### Important Security Considerations

- **Key Generation**: The script generates keys without passphrases by default for automation purposes. For interactive use, consider modifying the script to prompt for passphrases.
- **Permissions**: The script automatically sets proper permissions (600 for private keys, 644 for public keys).
- **Backup Security**: Backup directories maintain the same permissions as original keys. Store backups securely.
- **Key Rotation**: Always verify that new keys work before removing access to old keys on critical systems.

### Best Practices

1. **Regular Rotation**: Rotate keys regularly (quarterly or semi-annually)
2. **Backup Before Changes**: Always backup before rotating keys
3. **Test Deployments**: Test new keys on non-critical systems first
4. **Monitor Access**: Keep logs of key rotations and deployments
5. **Use Strong Key Types**: Prefer Ed25519 for new keys when supported

### Limitations

- **Passphrase Support**: Current implementation generates keys without passphrases for automation
- **Key Agent Integration**: Does not automatically add keys to SSH agent
- **Remote Validation**: Cannot validate that deployed keys actually work without manual testing
- **Platform Compatibility**: Requires OpenSSH tools (standard on Linux/macOS, available on Windows via WSL)

## Error Handling

The script includes comprehensive error handling for common scenarios:

- Missing SSH directory (automatically created)
- Existing key conflicts (prevents overwriting)
- Network connectivity issues during deployment
- Invalid key files or formats
- Permission errors

All errors are logged with appropriate detail levels based on the verbose flag.

## Troubleshooting

### Common Issues

1. **"ssh-keygen command not found"**
   - Install OpenSSH client tools
   - On Ubuntu/Debian: `sudo apt install openssh-client`
   - On RHEL/CentOS: `sudo yum install openssh-clients`

2. **Permission denied errors**
   - Ensure you have write access to the SSH directory
   - Check that SSH directory has proper permissions (700)

3. **Key deployment fails**
   - Verify network connectivity to target server
   - Ensure target server accepts key-based authentication
   - Check that ssh-copy-id is available

4. **"Key already exists" errors**
   - Use a different key name, or
   - Backup and remove existing key first, or
   - Use the rotate command instead

### Debug Mode

Use the verbose flag for detailed debugging information:

```bash
python ssh_key_manager.py --verbose <command> [options]
```

## Contributing

Contributions are welcome! Please consider the following:

- Follow PEP 8 style guidelines
- Add appropriate error handling and logging
- Include tests for new functionality
- Update documentation for new features

## License

MIT License

Copyright (c) 2025 SSH Key Manager Contributors

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

## Version History

- **v1.0.0**: Initial release with core functionality
  - Key generation (RSA, Ed25519, ECDSA)
  - Key rotation with backup
  - Key validation and listing
  - Remote deployment support
  - Comprehensive logging and error handling

## Support

For issues, questions, or contributions, please:

1. Check the troubleshooting section above
2. Review the error logs with verbose mode enabled
3. Create an issue in the project repository with:
   - Your operating system and Python version
   - The exact command that failed
   - The complete error output with verbose mode

---

*This script is designed for legitimate system administration and security management purposes. Always follow your organization's security policies and best practices when managing SSH keys.*
